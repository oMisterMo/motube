<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Search</title>
        <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
        <link href="../dist/output.css" rel="stylesheet" />
        <script defer>
            // Loads YT api
            // e.g. <script src="https://www.youtube.com/iframe_api"> <script>
            const tag = document.createElement("script");
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName("script")[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

            let player;

            async function getVideoId() {
                const data = await fetch("/timestamp");
                const timestamp = await data.json();

                if (timestamp) {
                    const url = new URL(timestamp.url);
                    const videoId = url.searchParams.get("v");
                    console.log("url: ", url);
                    console.log("v: ", videoId);
                    if (videoId) {
                        // correct search format
                        return videoId;
                    }
                }
                return "2Z4m4lnjxkY"; // trolol (something went wrong)
            }

            async function onYouTubeIframeAPIReady() {
                const id = await getVideoId();
                player = new YT.Player("player", {
                    height: "390",
                    videoId: id,
                    playerVars: {
                        playsinline: 1,
                    },
                    events: {
                        onReady: onPlayerReady,
                        onStateChange: onPlayerStateChange,
                    },
                });
            }

            let done = false;
            function onPlayerReady(event) {
                event.target.playVideo();
            }
            async function onPlayerStateChange(event) {
                if (event.data == YT.PlayerState.PLAYING && !done) {
                    setTimeout(stopVideo, 6000);
                    done = true;
                }
                if (event.data == YT.PlayerState.PAUSED) {
                    const data = {
                        timestamp: player.getCurrentTime(),
                        modified_at: Date.now(),
                    };
                    await fetch("/timestamp", {
                        method: "PUT",
                        headers: {
                            Accept: "application/json",
                            "Access-Control-Allow-Headers": "application/json",
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    });
                }
            }

            function stopVideo() {
                player.stopVideo();
            }
        </script>
    </head>
    <body>
        <div class="m-auto max-w-[640px]">
            <div id="player" class="flex w-full"></div>
        </div>
    </body>
</html>
